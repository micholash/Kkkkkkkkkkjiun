<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì•¼ìƒì˜ ë¹„ë‘˜ê¸° í‚¤ìš°ê¸°</title>
    <style>
        /* --- CSS ìŠ¤íƒ€ì¼ --- */
        :root {
            --item-size: 70px;
            --main-color: #FF9800;
            --bg-color: #87CEEB;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        .header {
            text-align: center;
            padding-top: 15px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            z-index: 10;
            pointer-events: none;
        }

        h1 { margin: 5px 0; font-size: 24px; }
        .score-board { font-size: 14px; background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 15px; display: inline-block;}

        /* ììœ  ê²Œì„ ì˜ì—­ */
        #game-area {
            position: relative;
            flex-grow: 1;
            width: 100%;
            background-color: #C5E1A5;
            background-image: 
                radial-gradient(circle at 10% 20%, #AED581 5%, transparent 5%),
                radial-gradient(circle at 90% 80%, #AED581 5%, transparent 5%);
            overflow: hidden;
            touch-action: none;
        }

        /* ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .item {
            position: absolute;
            width: var(--item-size);
            height: var(--item-size);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            touch-action: none;
            z-index: 10;
            user-select: none;
            overflow: hidden;
        }

        .item.dragging {
            opacity: 0.8;
            z-index: 1000;
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            cursor: grabbing;
        }

        .item .image-container {
            width: 70%;
            height: 70%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        .item .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .item .level { font-size: 11px; color: #555; font-weight: bold; margin-top: 2px; pointer-events: none; }

        .pop-anim { animation: pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes pop {
            0% { transform: scale(0) rotate(-30deg); }
            80% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            background: rgba(255,255,255,0.95);
            z-index: 100;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }

        .btn {
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* ì•Œ ë‚³ê¸° ë²„íŠ¼ */
        .spawn-btn {
            flex: 2; /* ë” ë„“ê²Œ */
            background-color: var(--main-color);
        }
        .spawn-btn:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }

        /* ë„ê° ë²„íŠ¼ */
        .book-btn {
            flex: 1;
            background-color: #4CAF50;
        }

        /* --- ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            width: 85%;
            max-width: 320px;
            max-height: 80vh;
            overflow-y: auto; /* ë‚´ìš© ê¸¸ë©´ ìŠ¤í¬ë¡¤ */
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: modal-pop 0.3s ease-out;
            position: relative;
        }
        @keyframes modal-pop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .close-btn-top {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
        }

        /* ì„¤ëª…ì°½ ìŠ¤íƒ€ì¼ */
        .modal-image { width: 120px; height: 120px; margin-bottom: 10px; object-fit: contain; }
        .modal-title { font-size: 24px; font-weight: bold; margin: 10px 0; color: #333; }
        .modal-badge { 
            display: inline-block; 
            background: #FFEB3B; 
            color: #333; 
            padding: 4px 10px; 
            border-radius: 10px; 
            font-size: 12px; 
            font-weight: bold; 
            margin-bottom: 10px;
        }
        .modal-desc { font-size: 16px; color: #666; line-height: 1.6; margin-bottom: 20px; word-break: keep-all; }
        .confirm-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--main-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        /* ë„ê° ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .book-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .book-item {
            aspect-ratio: 1/1;
            background-color: #f0f0f0;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }
        .book-item.unlocked { background-color: #fff; border-color: #ddd; }
        .book-item.locked { background-color: #e0e0e0; opacity: 0.6; cursor: default; }
        .book-item img { width: 70%; height: 70%; object-fit: contain; }
        .book-item .level-badge {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 10px;
            color: #888;
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ•Šï¸ ì•¼ìƒì˜ ë¹„ë‘˜ê¸°</h1>
        <div class="score-board">
            ë°œê²¬í•œ ë¹„ë‘˜ê¸°: <span id="max-level">0</span> / 20
        </div>
    </div>

    <div id="game-area">
        <!-- ë¹„ë‘˜ê¸° ìƒì„± ì˜ì—­ -->
    </div>

    <div class="controls">
        <button class="btn book-btn" id="bookBtn">ğŸ“– ë„ê°</button>
        <button class="btn spawn-btn" id="spawnBtn">ğŸ¥š ì•Œ ë‚³ê¸°</button>
    </div>

    <!-- 1. ìƒˆë¡œìš´ ë¹„ë‘˜ê¸° ë°œê²¬ ëª¨ë‹¬ -->
    <div id="unlockModal" class="modal">
        <div class="modal-content">
            <span class="modal-badge">âœ¨ NEW! ìƒˆë¡œìš´ ë¹„ë‘˜ê¸° ë°œê²¬!</span>
            <br>
            <img id="unlock-img" class="modal-image" src="" alt="ë¹„ë‘˜ê¸°">
            <div id="unlock-title" class="modal-title"></div>
            <div id="unlock-desc" class="modal-desc"></div>
            <button class="confirm-btn" id="unlockCloseBtn">í™•ì¸</button>
        </div>
    </div>

    <!-- 2. ë„ê° ëª¨ë‹¬ -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <button class="close-btn-top" id="bookCloseTopBtn">&times;</button>
            <div class="modal-title">ë¹„ë‘˜ê¸° ë„ê°</div>
            <p style="font-size:12px; color:#888; margin-bottom:15px;">ë°œê²¬í•œ ë¹„ë‘˜ê¸°ë¥¼ ëˆŒëŸ¬ ì„¤ëª…ì„ ë³´ì„¸ìš”.</p>
            <div class="book-grid" id="bookGrid">
                <!-- JSë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
    </div>

    <!-- 3. ë„ê° ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ (ë„ê°ì—ì„œ í´ë¦­ ì‹œ) -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <img id="detail-img" class="modal-image" src="" alt="ë¹„ë‘˜ê¸°">
            <div id="detail-title" class="modal-title"></div>
            <div id="detail-desc" class="modal-desc"></div>
            <button class="confirm-btn" id="detailCloseBtn">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // --- ë°ì´í„° (ì´ë¯¸ì§€ ì£¼ì†ŒëŠ” ê¼­ ê¹ƒí—ˆë¸Œ URLë¡œ êµì²´í•˜ì„¸ìš”!) ---
        const pigeonTypes = [
            { level: 1, image_url: "https://cdn-icons-png.flaticon.com/512/3199/3199887.png", name: "ë¹„ë‘˜ê¸° ì•Œ", description: "ì•„ì§ì€ í‰ë²”í•œ ì•Œì…ë‹ˆë‹¤. ë”°ëœ»í•˜ê²Œ í’ˆì–´ì£¼ë©´ ê¹¨ì–´ë‚ ê¹Œìš”?" },
            { level: 2, image_url: "https://cdn-icons-png.flaticon.com/512/3199/3199893.png", name: "ê¹¨ì§„ ì•Œ", description: "ì©! ê¸ˆì´ ê°€ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ì•ˆì— ë¬´ì–¸ê°€ ì›€ì§ì´ê³  ìˆì–´ìš”!" },
            { level: 3, image_url: "https://cdn-icons-png.flaticon.com/512/3199/3199912.png", name: "ì•„ê¸° ìƒˆ", description: "ì‚ì•½ì‚ì•½! ì•„ì£¼ ì‘ê³  ê·€ì—¬ìš´ ì•„ê¸° ë¹„ë‘˜ê¸°ê°€ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤." },
            { level: 4, image_url: "https://cdn-icons-png.flaticon.com/512/2696/2696307.png", name: "ë¹„ë‘˜ê¸°", description: "ìš°ë¦¬ê°€ ê³µì›ì—ì„œ í”íˆ ë§ˆì£¼ì¹˜ëŠ” í‰ë²”í•œ ë¹„ë‘˜ê¸°ì…ë‹ˆë‹¤. êµ¬êµ¬!" },
            { level: 5, image_url: "https://cdn-icons-png.flaticon.com/512/3075/3075973.png", name: "ë¹µë‘˜ê¸°", description: "ë¹µì„ ë„ˆë¬´ ì¢‹ì•„í•œ ë‚˜ë¨¸ì§€ ëª¸ì´ ë°”ê²ŒíŠ¸ ë¹µì´ ë˜ì–´ë²„ë ¸ìŠµë‹ˆë‹¤." },
            { level: 6, image_url: "https://cdn-icons-png.flaticon.com/512/1864/1864514.png", name: "ë‹­ë‘˜ê¸°", description: "ë„ˆë¬´ ì˜ ë¨¹ì–´ì„œ ë‚ ì§€ ëª»í•©ë‹ˆë‹¤. ë’¤ëš±ë’¤ëš± ê±¸ì–´ë‹¤ë‹™ë‹ˆë‹¤." },
            { level: 7, image_url: "https://cdn-icons-png.flaticon.com/512/616/616430.png", name: "ì•µë¬´ë‘˜ê¸°", description: "í™”ë ¤í•œ ê¹ƒí„¸ì„ ë™ê²½í•˜ì—¬ ë¬´ì§€ê°œìƒ‰ìœ¼ë¡œ ì—¼ìƒ‰í–ˆìŠµë‹ˆë‹¤." },
            { level: 8, image_url: "https://cdn-icons-png.flaticon.com/512/3063/3063188.png", name: "ë°±ì¡°ë‘˜ê¸°", description: "ìì‹ ì´ ë°±ì¡°ë¼ê³  ë¯¿ëŠ” ë¹„ë‘˜ê¸°ì…ë‹ˆë‹¤. í˜¸ìˆ˜ ìœ„ë¥¼ ë– ë‹¤ë‹™ë‹ˆë‹¤." },
            { level: 9, image_url: "https://cdn-icons-png.flaticon.com/512/2913/2913520.png", name: "í™í•™ë‘˜ê¸°", description: "ë‹¤ë¦¬ê°€ ê¸¸ì–´ì§€ê³  í•‘í¬ìƒ‰ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. í•œ ë°œë¡œ ì„œê¸°ë¥¼ ì¢‹ì•„í•©ë‹ˆë‹¤." },
            { level: 10, image_url: "https://cdn-icons-png.flaticon.com/512/2978/2978522.png", name: "ê³µì‘ë‘˜ê¸°", description: "ê´€ì‹¬ ë°›ëŠ” ê²ƒì„ ì¢‹ì•„í•©ë‹ˆë‹¤. í™”ë ¤í•œ ê¼¬ë¦¬ë¥¼ í™œì§ í´ê³  ë‹¤ë‹™ë‹ˆë‹¤." },
            { level: 11, image_url: "https://cdn-icons-png.flaticon.com/512/2622/2622324.png", name: "ë¶€ì—‰ë‘˜ê¸°", description: "ë‚®ì—ëŠ” ìê³  ë°¤ì—ë§Œ í™œë™í•©ë‹ˆë‹¤. ëˆˆì´ ì•„ì£¼ í½ë‹ˆë‹¤." },
            { level: 12, image_url: "https://cdn-icons-png.flaticon.com/512/2938/2938189.png", name: "ë…ìˆ˜ë¦¬", description: "ë” ì´ìƒ ë„ì‹œì˜ ë¹„ë‘˜ê¸°ê°€ ì•„ë‹™ë‹ˆë‹¤. í•˜ëŠ˜ì˜ ì œì™•ì´ ë˜ì—ˆìŠµë‹ˆë‹¤." },
            { level: 13, image_url: "https://cdn-icons-png.flaticon.com/512/2696/2696319.png", name: "ì˜¤ë¦¬ë‘˜ê¸°", description: "ê½¥ê½¥? ì •ì²´ì„±ì— í˜¼ë€ì´ ì˜¨ ë¹„ë‘˜ê¸°ì…ë‹ˆë‹¤. ë¬¼ê°ˆí€´ê°€ ìƒê²¼ìŠµë‹ˆë‹¤." },
            { level: 14, image_url: "https://cdn-icons-png.flaticon.com/512/1998/1998632.png", name: "ë°•ì¥ë‘˜ê¸°", description: "ì–´ë‘ ì˜ í˜ì„ ì–»ì–´ ë™êµ´ì—ì„œ ì„œì‹í•©ë‹ˆë‹¤. ì´ˆìŒíŒŒë¥¼ ì”ë‹ˆë‹¤." },
            { level: 15, image_url: "https://cdn-icons-png.flaticon.com/512/3306/3306290.png", name: "ìš©ë‘˜ê¸°", description: "ì „ì„¤ ì†ì˜ ì¡´ì¬ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. ê°€ë” ì…ì—ì„œ ë¶ˆì„ ë¿œìŠµë‹ˆë‹¤." },
            { level: 16, image_url: "https://cdn-icons-png.flaticon.com/512/2503/2503394.png", name: "ì „íˆ¬ê¸°", description: "ê¸°ê³„í™”ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ìŒì†ìœ¼ë¡œ í•˜ëŠ˜ì„ ë‚ ì•„ê°‘ë‹ˆë‹¤." },
            { level: 17, image_url: "https://cdn-icons-png.flaticon.com/512/3022/3022265.png", name: "í—¬ê¸°", description: "ì œìë¦¬ ë¹„í–‰ì´ ê°€ëŠ¥í•œ ìµœì²¨ë‹¨ ë¹„ë‘˜ê¸°ì…ë‹ˆë‹¤. í”„ë¡œí ëŸ¬ê°€ ë‹¬ë ¸ìŠµë‹ˆë‹¤." },
            { level: 18, image_url: "https://cdn-icons-png.flaticon.com/512/3199/3199904.png", name: "ë¡œì¼“", description: "ì§€êµ¬ì˜ ì¤‘ë ¥ì„ ë²—ì–´ë‚  ì¤€ë¹„ë¥¼ ë§ˆì³¤ìŠµë‹ˆë‹¤. 3, 2, 1, ë°œì‚¬!" },
            { level: 19, image_url: "https://cdn-icons-png.flaticon.com/512/2895/2895839.png", name: "UFO", description: "ì™¸ê³„ ë¬¸ëª…ê³¼ ì ‘ì´‰í•˜ì—¬ ì•Œ ìˆ˜ ì—†ëŠ” í˜ì„ ì–»ì—ˆìŠµë‹ˆë‹¤." },
            { level: 20, image_url: "https://cdn-icons-png.flaticon.com/512/3418/3418205.png", name: "ìš°ì£¼ì‹ ", description: "ëª¨ë“  ì°¨ì›ì˜ ë¹„ë‘˜ê¸°ë¥¼ ë‹¤ìŠ¤ë¦¬ëŠ” ì°½ì¡°ì‹ ì…ë‹ˆë‹¤. ê²Œì„ í´ë¦¬ì–´!" }
        ];

        // --- ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
        const gameArea = document.getElementById('game-area');
        const maxLevelDisplay = document.getElementById('max-level');
        const spawnBtn = document.getElementById('spawnBtn');
        const bookBtn = document.getElementById('bookBtn');
        const ITEM_SIZE = 70;

        // ëª¨ë‹¬ ìš”ì†Œë“¤
        const unlockModal = document.getElementById('unlockModal');
        const bookModal = document.getElementById('bookModal');
        const detailModal = document.getElementById('detailModal');

        let activeItem = null;
        let startX = 0, startY = 0;
        let initialPos = { x: 0, y: 0 };
        
        // â˜… ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (í•´ê¸ˆëœ ìµœê³  ë ˆë²¨) â˜…
        let maxUnlockedLevel = parseInt(localStorage.getItem('pigeon_max_level')) || 1;
        
        // ì´ˆê¸° UI ì—…ë°ì´íŠ¸
        maxLevelDisplay.innerText = maxUnlockedLevel;

        // --- 1. ê²Œì„ ë¡œì§ (ë“œë˜ê·¸ & ìƒì„±) ---
        
        function getRandomPosition() {
            const x = Math.random() * (gameArea.clientWidth - ITEM_SIZE);
            const y = Math.random() * (gameArea.clientHeight - ITEM_SIZE);
            return { x, y };
        }

        function createItem(level, x = null, y = null) {
            const data = pigeonTypes[level - 1];
            const item = document.createElement('div');
            item.classList.add('item');
            item.dataset.level = level;

            const pos = (x === null || y === null) ? getRandomPosition() : { x, y };
            item.style.left = `${pos.x}px`;
            item.style.top = `${pos.y}px`;

            item.innerHTML = `
                <div class="image-container">
                    <img src="${data.image_url}" alt="${data.name}" draggable="false">
                </div>
                <div class="level">Lv.${level}</div>
            `;
            
            item.classList.add('pop-anim');
            item.addEventListener('animationend', () => item.classList.remove('pop-anim'));
            item.addEventListener('pointerdown', handlePointerDown);
            
            gameArea.appendChild(item);
        }

        spawnBtn.addEventListener('click', () => {
            if (document.querySelectorAll('.item').length >= 30) {
                alert("ë¹„ë‘˜ê¸°ê°€ ë„ˆë¬´ ë§ì•„ìš”!");
                return;
            }
            createItem(1);
            spawnBtn.disabled = true;
            setTimeout(() => { spawnBtn.disabled = false; }, 300);
        });

        // --- ë“œë˜ê·¸ í•¸ë“¤ëŸ¬ ---
        function handlePointerDown(e) {
            e.preventDefault();
            activeItem = e.currentTarget;
            initialPos.x = parseFloat(activeItem.style.left);
            initialPos.y = parseFloat(activeItem.style.top);
            
            const rect = activeItem.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;

            activeItem.classList.add('dragging');
            activeItem.setPointerCapture(e.pointerId);

            activeItem.addEventListener('pointermove', handlePointerMove);
            activeItem.addEventListener('pointerup', handlePointerUp);
        }

        function handlePointerMove(e) {
            if (!activeItem) return;
            e.preventDefault();
            const areaRect = gameArea.getBoundingClientRect();
            let newX = e.clientX - areaRect.left - startX;
            let newY = e.clientY - areaRect.top - startY;
            newX = Math.max(0, Math.min(newX, gameArea.clientWidth - ITEM_SIZE));
            newY = Math.max(0, Math.min(newY, gameArea.clientHeight - ITEM_SIZE));
            activeItem.style.left = `${newX}px`;
            activeItem.style.top = `${newY}px`;
        }

        function handlePointerUp(e) {
            if (!activeItem) return;
            activeItem.removeEventListener('pointermove', handlePointerMove);
            activeItem.removeEventListener('pointerup', handlePointerUp);
            activeItem.classList.remove('dragging');
            activeItem.releasePointerCapture(e.pointerId);

            const targetItem = findCollidingItem(activeItem);

            if (targetItem) {
                const level1 = parseInt(activeItem.dataset.level);
                const level2 = parseInt(targetItem.dataset.level);

                if (level1 === level2 && level1 < 20) {
                    // í•©ì„± ì„±ê³µ
                    const newX = parseFloat(targetItem.style.left);
                    const newY = parseFloat(targetItem.style.top);
                    activeItem.remove();
                    targetItem.remove();
                    
                    const newLevel = level1 + 1;
                    createItem(newLevel, newX, newY);
                    
                    // â˜… ì¤‘ìš”: ì²˜ìŒ ë§Œë“œëŠ” ë ˆë²¨ì´ë¼ë©´ ì„¤ëª…ì°½ ë„ìš°ê¸° & ì €ì¥ â˜…
                    checkAndUnlockLevel(newLevel);

                } else {
                    returnToInitialPos(activeItem);
                }
            }
            activeItem = null;
        }

        function findCollidingItem(currentItem) {
            const currentRect = currentItem.getBoundingClientRect();
            const currentCenter = { x: currentRect.left + currentRect.width/2, y: currentRect.top + currentRect.height/2 };
            const items = document.querySelectorAll('.item');
            for (const item of items) {
                if (item === currentItem) continue;
                const rect = item.getBoundingClientRect();
                const itemCenter = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
                const dist = Math.sqrt(Math.pow(currentCenter.x - itemCenter.x, 2) + Math.pow(currentCenter.y - itemCenter.y, 2));
                if (dist < ITEM_SIZE * 0.7) return item;
            }
            return null;
        }

        function returnToInitialPos(item) {
            item.style.transition = 'all 0.2s ease-out';
            item.style.left = `${initialPos.x}px`;
            item.style.top = `${initialPos.y}px`;
            setTimeout(() => { item.style.transition = ''; }, 200);
        }

        // --- 2. í•´ê¸ˆ & ì €ì¥ ë¡œì§ ---

        function checkAndUnlockLevel(level) {
            // í˜„ì¬ ìµœê³  ë ˆë²¨ë³´ë‹¤ ë†’ì€ ë ˆë²¨ì„ ë§Œë“¤ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
            if (level > maxUnlockedLevel) {
                maxUnlockedLevel = level;
                localStorage.setItem('pigeon_max_level', maxUnlockedLevel);
                maxLevelDisplay.innerText = maxUnlockedLevel;
                
                // ì¶•í•˜ ëª¨ë‹¬ ë„ìš°ê¸°
                showUnlockModal(level);
            }
        }

        // --- 3. ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---

        // (1) ìƒˆë¡œìš´ ë°œê²¬ ëª¨ë‹¬
        function showUnlockModal(level) {
            const data = pigeonTypes[level - 1];
            document.getElementById('unlock-img').src = data.image_url;
            document.getElementById('unlock-title').innerText = `Lv.${level} ${data.name}`;
            document.getElementById('unlock-desc').innerText = data.description;
            unlockModal.style.display = 'flex';
        }
        document.getElementById('unlockCloseBtn').onclick = () => unlockModal.style.display = 'none';

        // (2) ë„ê° ì—´ê¸°/ë‹«ê¸°
        bookBtn.onclick = () => {
            renderBook(); // ë„ê° ë‚´ìš© ìƒˆë¡œê³ ì¹¨
            bookModal.style.display = 'flex';
        };
        document.getElementById('bookCloseTopBtn').onclick = () => bookModal.style.display = 'none';

        // (3) ë„ê° ë‚´ìš© ê·¸ë¦¬ê¸° (Locked/Unlocked ì²˜ë¦¬)
        function renderBook() {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = ''; // ì´ˆê¸°í™”

            pigeonTypes.forEach(data => {
                const slot = document.createElement('div');
                
                // í•´ê¸ˆ ì—¬ë¶€ í™•ì¸
                if (data.level <= maxUnlockedLevel) {
                    // í•´ê¸ˆë¨: ì´ë¯¸ì§€ ë³´ì´ê³  í´ë¦­ ê°€ëŠ¥
                    slot.classList.add('book-item', 'unlocked');
                    slot.innerHTML = `
                        <img src="${data.image_url}">
                        <div class="level-badge">${data.level}</div>
                    `;
                    slot.onclick = () => showDetailModal(data);
                } else {
                    // ì ê¹€: ë¬¼ìŒí‘œ í‘œì‹œ
                    slot.classList.add('book-item', 'locked');
                    slot.innerHTML = `<div style="font-size:24px; color:#aaa;">?</div><div class="level-badge">${data.level}</div>`;
                }
                grid.appendChild(slot);
            });
        }

        // (4) ë„ê° ìƒì„¸ ë³´ê¸° ëª¨ë‹¬
        function showDetailModal(data) {
            document.getElementById('detail-img').src = data.image_url;
            document.getElementById('detail-title').innerText = `Lv.${data.level} ${data.name}`;
            document.getElementById('detail-desc').innerText = data.description;
            detailModal.style.display = 'flex';
        }
        document.getElementById('detailCloseBtn').onclick = () => detailModal.style.display = 'none';

        // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = (e) => {
            if (e.target == unlockModal) unlockModal.style.display = 'none';
            if (e.target == bookModal) bookModal.style.display = 'none';
            if (e.target == detailModal) detailModal.style.display = 'none';
        }

        // ê²Œì„ ì‹œì‘ ì‹œ ì•Œ 2ê°œ ìƒì„±
        setTimeout(() => {
            createItem(1);
            createItem(1);
        }, 100);

    </script>
</body>
</html>
