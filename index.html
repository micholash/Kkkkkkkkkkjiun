<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì•¼ìƒì˜ ë¹„ë‘˜ê¸° í‚¤ìš°ê¸°</title>
    <style>
        /* --- CSS ìŠ¤íƒ€ì¼ --- */
        :root {
            --item-size: 70px;
            --main-color: #FF9800;
            --bg-color: #87CEEB;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        .header {
            text-align: center;
            padding-top: 15px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            z-index: 10;
            pointer-events: none;
        }

        h1 { margin: 5px 0; font-size: 24px; }
        .score-board { font-size: 14px; background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 15px; display: inline-block;}

        /* ììœ  ê²Œì„ ì˜ì—­ */
        #game-area {
            position: relative;
            flex-grow: 1;
            width: 100%;
            background-color: #C5E1A5;
            background-image: 
                radial-gradient(circle at 10% 20%, #AED581 5%, transparent 5%),
                radial-gradient(circle at 90% 80%, #AED581 5%, transparent 5%);
            overflow: hidden;
            touch-action: none;
        }

        /* ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .item {
            position: absolute;
            width: var(--item-size);
            height: var(--item-size);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            touch-action: none;
            z-index: 10;
            user-select: none;
            overflow: hidden;
        }

        .item.dragging {
            opacity: 0.8;
            z-index: 1000;
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            cursor: grabbing;
        }

        .item .image-container {
            width: 70%;
            height: 70%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        .item .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .item .level { font-size: 11px; color: #555; font-weight: bold; margin-top: 2px; pointer-events: none; }

        .pop-anim { animation: pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes pop {
            0% { transform: scale(0) rotate(-30deg); }
            80% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            background: rgba(255,255,255,0.95);
            z-index: 100;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        .spawn-btn { flex: 2; background-color: var(--main-color); }
        .spawn-btn:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }
        .book-btn { flex: 1; background-color: #4CAF50; }

        /* --- ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            width: 85%;
            max-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: modal-pop 0.3s ease-out;
            position: relative;
        }
        @keyframes modal-pop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .close-btn-top {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal-image { width: 120px; height: 120px; margin-bottom: 10px; object-fit: contain; }
        .modal-title { font-size: 24px; font-weight: bold; margin: 10px 0; color: #333; }
        .modal-badge { 
            display: inline-block; background: #FFEB3B; color: #333; 
            padding: 4px 10px; border-radius: 10px; font-size: 12px; font-weight: bold; margin-bottom: 10px;
        }
        .modal-desc { font-size: 16px; color: #666; line-height: 1.6; margin-bottom: 20px; word-break: keep-all; }
        .confirm-btn {
            width: 100%; padding: 12px; background-color: var(--main-color);
            color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;
        }

        .book-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .book-item {
            aspect-ratio: 1/1; background-color: #f0f0f0; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; border: 2px solid transparent; position: relative;
        }
        .book-item.unlocked { background-color: #fff; border-color: #ddd; }
        .book-item.locked { background-color: #e0e0e0; opacity: 0.6; cursor: default; }
        .book-item img { width: 70%; height: 70%; object-fit: contain; }
        .book-item .level-badge { position: absolute; bottom: 2px; right: 2px; font-size: 10px; color: #888; }

    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ•Šï¸ ì•¼ìƒì˜ ë¹„ë‘˜ê¸°</h1>
        <div class="score-board">
            ìµœê³  ë ˆë²¨: <span id="max-level">0</span>
        </div>
    </div>

    <div id="game-area"></div>

    <div class="controls">
        <button class="btn book-btn" id="bookBtn">ğŸ“– ë„ê°</button>
        <button class="btn spawn-btn" id="spawnBtn">ğŸ¥š ì•Œ ë‚³ê¸°</button>
    </div>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="unlockModal" class="modal">
        <div class="modal-content">
            <span class="modal-badge">âœ¨ NEW! ìƒˆë¡œìš´ ë°œê²¬!</span><br>
            <img id="unlock-img" class="modal-image" src="" alt="ë¹„ë‘˜ê¸°">
            <div id="unlock-title" class="modal-title"></div>
            <div id="unlock-desc" class="modal-desc"></div>
            <button class="confirm-btn" id="unlockCloseBtn">í™•ì¸</button>
        </div>
    </div>

    <div id="bookModal" class="modal">
        <div class="modal-content">
            <button class="close-btn-top" id="bookCloseTopBtn">&times;</button>
            <div class="modal-title">ë¹„ë‘˜ê¸° ë„ê°</div>
            <p style="font-size:12px; color:#888; margin-bottom:15px;">í„°ì¹˜í•˜ì—¬ ì„¤ëª…ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            <div class="book-grid" id="bookGrid"></div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <img id="detail-img" class="modal-image" src="" alt="ë¹„ë‘˜ê¸°">
            <div id="detail-title" class="modal-title"></div>
            <div id="detail-desc" class="modal-desc"></div>
            <button class="confirm-btn" id="detailCloseBtn">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // â˜… ë°ì´í„° ì„¤ì • (ê¹ƒí—ˆë¸Œì— img1.png ~ img19.png, img523.pngë¥¼ ì˜¬ë ¤ì•¼ í•¨) â˜…
        const pigeonTypes = [
            { level: 1, img: "img1.png", name: "ë¹„ë‘˜ê¸° ì•Œ", desc: "ì•„ì§ì€ í‰ë²”í•œ ì•Œì…ë‹ˆë‹¤." },
            { level: 2, img: "img2.png", name: "ê¹¨ì§„ ì•Œ", desc: "ê¸ˆì´ ê°”ìŠµë‹ˆë‹¤! ê³§ ë‚˜ì˜µë‹ˆë‹¤." },
            { level: 3, img: "img3.png", name: "ì•„ê¸° ìƒˆ", desc: "ì‚ì•½ì‚ì•½! ê·€ì—¬ìš´ ì•„ê¸° ìƒˆì…ë‹ˆë‹¤." },
            { level: 4, img: "img4.png", name: "ë¹„ë‘˜ê¸°", desc: "í”íˆ ë³´ëŠ” í‰ë²”í•œ ë¹„ë‘˜ê¸°ì…ë‹ˆë‹¤." },
            { level: 5, img: "img5.png", name: "ë¹µë‘˜ê¸°", desc: "ë¹µì„ ë„ˆë¬´ ì¢‹ì•„í•´ ëª¸ì´ ë³€í–ˆìŠµë‹ˆë‹¤." },
            { level: 6, img: "img6.png", name: "ë‹­ë‘˜ê¸°", desc: "ë„ˆë¬´ ë§ì´ ë¨¹ì–´ ë‚  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
            { level: 7, img: "img7.png", name: "ì•µë¬´ë‘˜ê¸°", desc: "í™”ë ¤í•œ ìƒ‰ìœ¼ë¡œ ì—¼ìƒ‰í–ˆìŠµë‹ˆë‹¤." },
            { level: 8, img: "img8.png", name: "ë°±ì¡°ë‘˜ê¸°", desc: "ìš°ì•„í•¨ì„ ì¶”êµ¬í•˜ëŠ” ë¹„ë‘˜ê¸°ì…ë‹ˆë‹¤." },
            { level: 9, img: "img9.png", name: "í™í•™ë‘˜ê¸°", desc: "ë‹¤ë¦¬ê°€ ê¸¸ì–´ì§€ê³  í•‘í¬ìƒ‰ì´ ë˜ì—ˆìŠµë‹ˆë‹¤." },
            { level: 10, img: "img10.png", name: "ê³µì‘ë‘˜ê¸°", desc: "ê´€ì‹¬ë°›ê¸°ë¥¼ ì¢‹ì•„í•˜ëŠ” ê´€ì¢…ì…ë‹ˆë‹¤." },
            { level: 11, img: "img11.png", name: "ë¶€ì—‰ë‘˜ê¸°", desc: "ë°¤ì—ë§Œ í™œë™í•˜ëŠ” ì•¼í–‰ì„±ì…ë‹ˆë‹¤." },
            { level: 12, img: "img12.png", name: "ë…ìˆ˜ë¦¬", desc: "í•˜ëŠ˜ì˜ ì œì™•ì´ ë˜ì—ˆìŠµë‹ˆë‹¤." },
            { level: 13, img: "img13.png", name: "ì˜¤ë¦¬ë‘˜ê¸°", desc: "ë¬¼ê°ˆí€´ê°€ ìƒê²¨ ìˆ˜ì˜ì„ ì˜í•©ë‹ˆë‹¤." },
            { level: 14, img: "img14.png", name: "ë°•ì¥ë‘˜ê¸°", desc: "ë™êµ´ì— ì„œì‹í•˜ë©° ì´ˆìŒíŒŒë¥¼ ì”ë‹ˆë‹¤." },
            { level: 15, img: "img15.png", name: "ìš©ë‘˜ê¸°", desc: "ì „ì„¤ ì†ì˜ ì¡´ì¬ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤." },
            { level: 16, img: "img16.png", name: "ì „íˆ¬ê¸°", desc: "ìŒì†ìœ¼ë¡œ ë‚ ì•„ê°€ëŠ” ê¸°ê³„ ë¹„ë‘˜ê¸°ì…ë‹ˆë‹¤." },
            { level: 17, img: "img17.png", name: "í—¬ê¸°", desc: "ì œìë¦¬ ë¹„í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤." },
            { level: 18, img: "img18.png", name: "ë¡œì¼“", desc: "ìš°ì£¼ë¡œ ê°ˆ ì¤€ë¹„ë¥¼ ë§ˆì³¤ìŠµë‹ˆë‹¤." },
            { level: 19, img: "img19.png", name: "UFO", desc: "ì™¸ê³„ ë¬¸ëª…ì˜ í˜ì„ ì–»ì—ˆìŠµë‹ˆë‹¤." },
            // â˜… ì¤‘ìš”: 20ë ˆë²¨ ëŒ€ì‹  523ë ˆë²¨ë¡œ ì„¤ì • â˜…
            { level: 523, img: "img523.png", name: "ìš°ì£¼ì‹ ", desc: "ëª¨ë“  ì°¨ì›ì„ ë‹¤ìŠ¤ë¦¬ëŠ” ì°½ì¡°ì‹ ì…ë‹ˆë‹¤." }
        ];

        const gameArea = document.getElementById('game-area');
        const maxLevelDisplay = document.getElementById('max-level');
        const spawnBtn = document.getElementById('spawnBtn');
        const bookBtn = document.getElementById('bookBtn');
        const ITEM_SIZE = 70;

        // ëª¨ë‹¬ ìš”ì†Œë“¤
        const unlockModal = document.getElementById('unlockModal');
        const bookModal = document.getElementById('bookModal');
        const detailModal = document.getElementById('detailModal');

        let activeItem = null;
        let startX = 0, startY = 0;
        let initialPos = { x: 0, y: 0 };
        
        // ì €ì¥ëœ ìµœê³  ë ˆë²¨ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ 1)
        let maxUnlockedLevel = parseInt(localStorage.getItem('pigeon_max_level')) || 1;
        maxLevelDisplay.innerText = "Lv." + maxUnlockedLevel;

        // --- í—¬í¼ í•¨ìˆ˜: ë ˆë²¨ë¡œ ë°ì´í„° ì°¾ê¸° ---
        function getPigeonData(level) {
            return pigeonTypes.find(p => p.level === level);
        }

        // --- ê²Œì„ ë¡œì§ ---
        function getRandomPosition() {
            const x = Math.random() * (gameArea.clientWidth - ITEM_SIZE);
            const y = Math.random() * (gameArea.clientHeight - ITEM_SIZE);
            return { x, y };
        }

        function createItem(level, x = null, y = null) {
            const data = getPigeonData(level);
            if (!data) return; // ë°ì´í„° ì—†ìœ¼ë©´ ì¤‘ë‹¨

            const item = document.createElement('div');
            item.classList.add('item');
            item.dataset.level = level;

            const pos = (x === null || y === null) ? getRandomPosition() : { x, y };
            item.style.left = `${pos.x}px`;
            item.style.top = `${pos.y}px`;

            // ./img1.png í˜•ì‹ìœ¼ë¡œ ê²½ë¡œ ì„¤ì •
            item.innerHTML = `
                <div class="image-container">
                    <img src="./${data.img}" alt="${data.name}" draggable="false" onerror="this.src='https://via.placeholder.com/70?text=IMG'">
                </div>
                <div class="level">Lv.${level}</div>
            `;
            
            item.classList.add('pop-anim');
            item.addEventListener('animationend', () => item.classList.remove('pop-anim'));
            item.addEventListener('pointerdown', handlePointerDown);
            
            gameArea.appendChild(item);
        }

        spawnBtn.addEventListener('click', () => {
            if (document.querySelectorAll('.item').length >= 40) {
                alert("ë¹„ë‘˜ê¸°ê°€ ë„ˆë¬´ ë§ì•„ìš”!");
                return;
            }
            createItem(1);
            spawnBtn.disabled = true;
            setTimeout(() => { spawnBtn.disabled = false; }, 200);
        });

        // --- ë“œë˜ê·¸ í•¸ë“¤ëŸ¬ ---
        function handlePointerDown(e) {
            e.preventDefault();
            activeItem = e.currentTarget;
            initialPos.x = parseFloat(activeItem.style.left);
            initialPos.y = parseFloat(activeItem.style.top);
            
            const rect = activeItem.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;

            activeItem.classList.add('dragging');
            activeItem.setPointerCapture(e.pointerId);
            activeItem.addEventListener('pointermove', handlePointerMove);
            activeItem.addEventListener('pointerup', handlePointerUp);
        }

        function handlePointerMove(e) {
            if (!activeItem) return;
            e.preventDefault();
            const areaRect = gameArea.getBoundingClientRect();
            let newX = e.clientX - areaRect.left - startX;
            let newY = e.clientY - areaRect.top - startY;
            newX = Math.max(0, Math.min(newX, gameArea.clientWidth - ITEM_SIZE));
            newY = Math.max(0, Math.min(newY, gameArea.clientHeight - ITEM_SIZE));
            activeItem.style.left = `${newX}px`;
            activeItem.style.top = `${newY}px`;
        }

        function handlePointerUp(e) {
            if (!activeItem) return;
            activeItem.removeEventListener('pointermove', handlePointerMove);
            activeItem.removeEventListener('pointerup', handlePointerUp);
            activeItem.classList.remove('dragging');
            activeItem.releasePointerCapture(e.pointerId);

            const targetItem = findCollidingItem(activeItem);

            if (targetItem) {
                const level1 = parseInt(activeItem.dataset.level);
                const level2 = parseInt(targetItem.dataset.level);

                // â˜… í•©ì„± ì¡°ê±´: ê°™ì€ ë ˆë²¨ì´ê³ , 523ë ˆë²¨ ë¯¸ë§Œì¼ ë•Œë§Œ â˜…
                if (level1 === level2 && level1 < 523) {
                    const newX = parseFloat(targetItem.style.left);
                    const newY = parseFloat(targetItem.style.top);
                    activeItem.remove();
                    targetItem.remove();
                    
                    // â˜… 19ë ˆë²¨ + 19ë ˆë²¨ -> 523ë ˆë²¨ë¡œ ì í”„ â˜…
                    let nextLevel = level1 + 1;
                    if (level1 === 19) nextLevel = 523;

                    createItem(nextLevel, newX, newY);
                    checkAndUnlockLevel(nextLevel);

                } else {
                    returnToInitialPos(activeItem);
                }
            }
            activeItem = null;
        }

        function findCollidingItem(currentItem) {
            const currentRect = currentItem.getBoundingClientRect();
            const currentCenter = { x: currentRect.left + currentRect.width/2, y: currentRect.top + currentRect.height/2 };
            const items = document.querySelectorAll('.item');
            for (const item of items) {
                if (item === currentItem) continue;
                const rect = item.getBoundingClientRect();
                const itemCenter = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
                const dist = Math.sqrt(Math.pow(currentCenter.x - itemCenter.x, 2) + Math.pow(currentCenter.y - itemCenter.y, 2));
                if (dist < ITEM_SIZE * 0.7) return item;
            }
            return null;
        }

        function returnToInitialPos(item) {
            item.style.transition = 'all 0.2s ease-out';
            item.style.left = `${initialPos.x}px`;
            item.style.top = `${initialPos.y}px`;
            setTimeout(() => { item.style.transition = ''; }, 200);
        }

        // --- í•´ê¸ˆ ë° ë„ê° ë¡œì§ ---
        function checkAndUnlockLevel(level) {
            // ì €ì¥ëœ ìµœê³  ë ˆë²¨ë³´ë‹¤ ë†’ìœ¼ë©´ í•´ê¸ˆ (523ì€ 19ë³´ë‹¤ í¬ë¯€ë¡œ ì •ìƒ ì‘ë™)
            if (level > maxUnlockedLevel) {
                maxUnlockedLevel = level;
                localStorage.setItem('pigeon_max_level', maxUnlockedLevel);
                maxLevelDisplay.innerText = "Lv." + maxUnlockedLevel;
                showUnlockModal(level);
            }
        }

        function showUnlockModal(level) {
            const data = getPigeonData(level);
            document.getElementById('unlock-img').src = "./" + data.img;
            document.getElementById('unlock-title').innerText = `Lv.${level} ${data.name}`;
            document.getElementById('unlock-desc').innerText = data.desc;
            unlockModal.style.display = 'flex';
        }

        // ë„ê° ê·¸ë¦¬ê¸°
        function renderBook() {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = ''; 

            pigeonTypes.forEach(data => {
                const slot = document.createElement('div');
                
                // í•´ê¸ˆ ì—¬ë¶€ ì²´í¬ (523 ë ˆë²¨ ì²˜ë¦¬ í¬í•¨)
                let isUnlocked = false;
                if (data.level <= maxUnlockedLevel) isUnlocked = true;
                // ì˜ˆì™¸ì²˜ë¦¬: maxUnlockedLevelì´ 19ì¸ë° 523ì„ ì²´í¬í•˜ë©´ ì•ˆë¨. 
                // ë‹¨ìˆœíˆ ìˆ«ì ë¹„êµë§Œ í•˜ë©´ 523 > 19ë¼ì„œ ì•ˆ ì—´ë¦¼. ì •ìƒ.
                // ë§Œì•½ maxUnlockedLevelì´ 523ì´ë©´ ë‹¤ ì—´ë¦¼. ì •ìƒ.

                if (isUnlocked) {
                    slot.classList.add('book-item', 'unlocked');
                    slot.innerHTML = `
                        <img src="./${data.img}" onerror="this.style.display='none'">
                        <div class="level-badge">${data.level}</div>
                    `;
                    slot.onclick = () => showDetailModal(data);
                } else {
                    slot.classList.add('book-item', 'locked');
                    slot.innerHTML = `<div style="font-size:20px; color:#aaa;">?</div><div class="level-badge">${data.level}</div>`;
                }
                grid.appendChild(slot);
            });
        }

        function showDetailModal(data) {
            document.getElementById('detail-img').src = "./" + data.img;
            document.getElementById('detail-title').innerText = `Lv.${data.level} ${data.name}`;
            document.getElementById('detail-desc').innerText = data.desc;
            detailModal.style.display = 'flex';
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('unlockCloseBtn').onclick = () => unlockModal.style.display = 'none';
        bookBtn.onclick = () => { renderBook(); bookModal.style.display = 'flex'; };
        document.getElementById('bookCloseTopBtn').onclick = () => bookModal.style.display = 'none';
        document.getElementById('detailCloseBtn').onclick = () => detailModal.style.display = 'none';
        window.onclick = (e) => {
            if (e.target == unlockModal) unlockModal.style.display = 'none';
            if (e.target == bookModal) bookModal.style.display = 'none';
            if (e.target == detailModal) detailModal.style.display = 'none';
        }

        // ì‹œì‘ ì‹œ ê¸°ë³¸ ì•„ì´í…œ ìƒì„±
        setTimeout(() => { createItem(1); createItem(1); }, 100);
    </script>
</body>
</html>
